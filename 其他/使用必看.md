## 使用必看



1.相关说明采用Markdown文件的形式进行说明，若本地无法打开，可使用Typora编辑器打开。[Typora下载地址](https://www.typora.io/)

2.AF_INET为协议族 表示ipv4地址和对应的端口号





简单测试，服务器是否可以和客户端进行通信

虚拟机 centos7 环境：

找到目录中的  service.cpp，client.cpp文件

使用g++ service.cpp -o service 编译服务端 ，g++ client.cpp -o client 编译客户端

先运行服务端 ./service

再运行客户端 ./client 127.0.0.1

客户端输入数据，查看服务端是否正常显示。



腾讯云云服务器 centos7 环境：

将service.cpp上传服务器，再次编译运行，./client 127.0.0.1中的127.0.0.1换成服务器公网IP，查看是否正常连接，若提示错误.

查看服务器安全组策略

入站规则：是否允许通过通信端口，例如代码中的6666端口

![image-20210619163903232](C:\Users\fdog\AppData\Roaming\Typora\typora-user-images\image-20210619163903232.png)

出战规则:是否允许通过通信端口，例如代码中的6666端口

![image-20210619164039598](C:\Users\fdog\AppData\Roaming\Typora\typora-user-images\image-20210619164039598.png)





客户端 ——服务端——客户端



登陆时创建一个TCP连接，登陆后断开，每隔30秒进行一次连接，如果能连上，说明在线，循环往复

采用p2p的形式进行客户端与客户端的通信，在总多p2p形式中选择udp打洞的方式进行互相通信



客户端A通过udp协议向服务器发送数据包，服务器收到后，获取数据包，并且可获取客户端A地址和端口号

客户端B通过udp协议向服务器发送数据包，服务器收到后，获取数据包，并且可获得客户端B地址和端口号

将A和B的地址和端口号分别发送给对方，进而AB可以继续使用UDP协议进行临时通信



消息格式

IP+端口+目的方+发送方+数据类型+内容



服务端检测客户端是否在线，若在线，直接采用p2p通信，但是要解决聊天记录保存的问题



服务端只负责转发



双方在线，采用UDP点对点通讯



其中一方不在线，采用服务器转发的方式，TCP

通讯

当双方都在线时，客户端与客户端的通信采用UDP协议进行打洞实现P2P（点对点）方式通信，即客户端与客户端直接进行信息传输，无需通过服务端，减少服务端压力。

UDP打洞：

客户端A想要访问服务端，先是通过NAT转换，客户端A的内网IP地址会被转换为NAT的公网IP，并为客户端A分配一个临时空闲的端口，这种方式可以解决IP地址不够的问题，有了NAT，多台客户端可以共用一个公网IP地址，同时也出现新的问题，就是如果服务端想要主动访问客户端A是很困难的，因为NAT这时并没有为客户端A提供端口映射，而客户端B想要访问NAT背后的客户端A就更不容易了。

所以想要使两个客户端通信，就必须让对方都知道自己的公网IP以及端口号，怎么知道，只能让客户端主动访问服务端，客户端会被分配一个端口，服务端记录该客户端公网IP以及端口号，以及需要访问的对应客户端，并转发给对应客户端，对应客户端也进行相同的操作。

流程如下：

（1）ClientA请求Server。

（2）ClientB请求Server。

（3）Server把ClientA的IP和端口信息发给ClientB。

（4）Server把ClientB的IP和端口信息发给ClientA。

（5）ClientA利用信息给ClientB发消息。（A信任B）

（6）ClinetB利用信息给ClientA发消息。（B信任A）



需要注意的是，客户端A知道了B的信息，通常也不能给B发送消息，因为这是不可信来源，类似于回应，需要B也给A发送消息，然后A，B双方才可以正常通信

服务端充当一个中间人的角色，因为服务端的IP和端口是固定不变了，所以客户端想要使用UDP协议访问服务端是很容易的，服务端只需要将双方信息进行交换即可。



当目的客户端一方不在线时，使用TCP连接进行暂时存储，保存信息，检测到对方上线，将消息通过TCP进行转发目的客户端。

















